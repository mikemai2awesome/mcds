---
import { componentSchemas } from '../schemas/component-schemas.js';

interface Props {
  title: string;
  siteName?: string;
}

const { title, siteName = "MCDS" } = Astro.props;
const currentPath = Astro.url.pathname;
const baseUrl = import.meta.env.BASE_URL;
const isIndexPage = currentPath === baseUrl || currentPath === baseUrl.replace(/\/$/, '') || currentPath === "/" || currentPath === "";

// Helper function to check if a link is the current page
const isCurrentPage = (href: string) => {
  // Normalize paths by removing trailing slashes
  const normalizePath = (path: string) => {
    return path.replace(/\/$/, '') || '/';
  };
  
  const normalizedCurrent = normalizePath(currentPath);
  const normalizedHref = normalizePath(href);
  
  return normalizedCurrent === normalizedHref;
};

// Check if we're on a component documentation page
const isComponentPage = currentPath.includes('/components/');
let componentDescription = "A design system built with Astro, MCSS, semantic HTML, and vanilla JavaScript.";

if (isComponentPage) {
  // Extract component name from URL (e.g., '/components/alert' or '/mcds/components/alert' -> 'alert')
  const componentSlug = currentPath.split('/components/')[1]?.replace('/', '');
  
  if (componentSlug) {
    // Convert slug to component name (e.g., 'popup-nav' -> 'PopupNav')
    const componentName = componentSlug
      .split('-')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join('');
    
    // Get component description from schema
    const schema = componentSchemas[componentName];
    if (schema) {
      componentDescription = schema.description;
    }
  }
}

// Dynamically get all component pages
const componentPages = await Astro.glob('../pages/components/*.astro');

// Extract component information and sort alphabetically
const components = componentPages
  .map(page => {
    // Extract filename without extension
    const filename = page.file.split('/').pop()?.replace('.astro', '') || '';
    
    // Convert filename to display name (e.g., 'popup-nav' -> 'Popup Nav')
    const displayName = filename
      .split('-')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
    
    return {
      name: displayName,
      href: `${import.meta.env.BASE_URL}components/${filename}/`,
      filename
    };
  })
  .sort((a, b) => a.name.localeCompare(b.name));

---

<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {
      isIndexPage ? (
        <title>{siteName} - Minimalist Design System by Mike Mai</title>
        <meta
          name="description"
          content="A design system built with Astro, MCSS, semantic HTML, and vanilla JavaScript."
        />
      ) : (
        <title>{title} - {siteName}</title>
        <meta
          name="description"
          content={componentDescription}
        />
      )
    }
    <link rel="canonical" href="https://mikemai.net/mcds/" />

    <!-- Open Graph -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@mikemai2awesome" />
    <meta name="twitter:creator" content="@mikemai2awesome" />
    <meta property="og:url" content="https://mikemai.net/mcds/" />
    {
      isIndexPage ? (
        <meta property="og:title" content={`${siteName} - Minimalist Design System by Mike Mai`} />
        <meta property="og:description" content="A design system built with Astro, MCSS, semantic HTML, and vanilla JavaScript." />
      ) : (
        <meta property="og:title" content={`${title} - ${siteName}`} />
        <meta property="og:description" content={componentDescription} />
      )
    }
    <meta property="og:locale" content="en_US" />
    <meta property="og:image" content="https://mikemai.net/mcds/img/og-image.jpg" />
    <meta property="og:image:alt" content="MCDS" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="672" />
    <meta property="og:site_name" content="Mike Mai Network" />

    <link rel="me" href="https://github.com/mikemai2awesome" />
    <link rel="me" href="https://mastodon.social/@mikemai2awesome" />
    <link rel="me" href="https://x.com/mikemai2awesome" />

    <!-- Favicons -->
    <link rel="icon" href="https://mikemai.net/favicon.ico" sizes="any" />
    <link rel="icon" href="https://mikemai.net/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://mikemai.net/apple-touch-icon.png" />
    <link rel="manifest" href="https://mikemai.net/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#000" />
    <meta name="theme-color" content="#000" />

    <!-- Misc. -->
    <meta name="generator" content={Astro.generator} />
    {isIndexPage && (
      <>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Flow+Block&display=swap" rel="stylesheet">
      </>
    )}
  </head>
  <body>
    {!isIndexPage && (
      <a href="#main-content" class="u-skip-link">Skip to main content</a>
      <header class="doc-header">
        <p><a href={import.meta.env.BASE_URL}>{siteName}</a></p>
        <nav>
          <ul>
            {components.map(component => (
              <li>
                <a 
                  href={component.href} 
                  aria-current={isCurrentPage(component.href) ? "page" : undefined}
                >
                  {component.name}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </header>
      <hr>  
    )}
    {
      isIndexPage ? (
        <main class="doc-main" id="main-content">
          <slot />
        </main>
      ) : (
        <main id="main-content">
          <slot />
        </main>
      )
    }
    <hr>
    <footer>
      <p><em>Made by <a href="https://mikemai.net">Mike Mai</a> with the help of AI buddy <a href="https://cursor.com">Cursor</a>.</em></p>
    </footer>
  </body>
</html>

<style is:global>
  @import url("../styles/global.css");
</style>

<script>
  // Global theme management
  class ThemeManager {
    static instance;
    
    constructor() {
      this.htmlElement = document.documentElement;
      this.storageKey = "verdana-theme";
      this.init();
    }
    
    static getInstance() {
      if (!ThemeManager.instance) {
        ThemeManager.instance = new ThemeManager();
      }
      return ThemeManager.instance;
    }
    
    init() {
      // Apply saved theme on page load
      this.applySavedTheme();
      
      // Listen for storage changes from other tabs
      window.addEventListener("storage", (event) => {
        if (event.key === this.storageKey) {
          this.applySavedTheme();
          this.notifyThemeChange();
        }
      });
      
      // Listen for custom theme change events
      document.addEventListener("theme-change", () => {
        this.applySavedTheme();
      });
    }
    
    applySavedTheme() {
      const savedTheme = localStorage.getItem(this.storageKey);
      const shouldApplyVerdana = savedTheme === "true";
      
      if (shouldApplyVerdana) {
        this.htmlElement.setAttribute("data-theme", "verdana");
      } else {
        this.htmlElement.removeAttribute("data-theme");
      }
    }
    
    isVerdanaActive() {
      return this.htmlElement.getAttribute("data-theme") === "verdana";
    }
    
    toggleTheme(enable) {
      if (enable) {
        this.htmlElement.setAttribute("data-theme", "verdana");
      } else {
        this.htmlElement.removeAttribute("data-theme");
      }
      
      localStorage.setItem(this.storageKey, enable.toString());
      this.notifyThemeChange();
    }
    
    notifyThemeChange() {
      // Dispatch event to notify components of theme change
      const event = new CustomEvent("theme-changed", {
        detail: { verdanaActive: this.isVerdanaActive() },
      });
      document.dispatchEvent(event);
    }
    
    getSavedState() {
      return localStorage.getItem(this.storageKey) === "true";
    }
  }
  
  // Initialize theme manager when DOM is ready
  function initThemeManager() {
    window.themeManager = ThemeManager.getInstance();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeManager);
  } else {
    initThemeManager();
  }
</script>
